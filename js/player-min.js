const ID3=window.jsmediatags;
const sin=Math.sin;
const Ï€=Math.PI;
var urlParameter=false;
function replaceurl(e){var t=window.location.protocol+"//"+window.location.host+window.location.pathname+"?"+e;window.history.pushState({path:t},"",t)}function getRMS(e){var t=0;var a=0;var n=0;var r=e.length;for(var i=0;i<r;i++)t+=Math.pow(e[i],2);return a=t/r,n=Math.sqrt(a),n}function calcRMSColor(e){let t=e/100;let a=150*t;return a}window.addEventListener("load",function(){var e=document.getElementById("thefile");var t=document.getElementById("file-label");document.getElementById("media-container").innerHTML=`<img id="img2"></img>\n<canvas id="canvas"></canvas>\n<div id="main">\n    <div id="album">\n        <div id="MediaPlayerControls">\n            <div id="MediaPlayerIcon-icon-play" class="MediaPlayerIcon icon-play" data-mediathumb-url="src"></div>\n            <div id="sound_options" class="MediaPlayerIcon icon-volume">\n                <input id="volume" class="MediaPlayerControl-volume" type="range" max="100" min="0" />\n            </div>\n        </div>\n        <input id="MediaPlayerControl-seekbar" type="range" name="rng" min="0" value="0">\n       <div id="time-position"></div>\n    </div>\n</div>\n <script src="../../js/rangeRunner.js"><\/script>\n`,replaceurl("player="+urlParameter);var a=new Audio;console.log(a);var n=document.getElementById("MediaPlayerControl-seekbar");var r=document.getElementById("album");var i=document.getElementById("img2");var o=document.getElementById("MediaPlayerIcon-icon-play");var l=document.getElementById("MediaPlayerIcon-icon-play");var c=document.getElementById("time-position");var d=document.getElementById("sound_options");var u=document.getElementById("volume");var s=true;function m(e){var t=Math.floor(e/60);var a=Math.floor(e-60*t);return a<10&&(a="0"+a),t+":"+a}e.onchange=function(){var e=[];e=this.files;var g=0;o.setAttribute("data-mediathumb-url",URL.createObjectURL(e[0]));var v=o.getAttribute("data-mediathumb-url");function f(a,n){if(true===s){s=false;var l=e[n].name;o.setAttribute("data-mediathumb-url",URL.createObjectURL(e[n]));var c=o.getAttribute("data-mediathumb-url");a.src=c,a.load();l=e[n].name;t.textContent!="Unknown Artist - "+e[n].name&&(t.textContent="Unknown Artist - "+e[n].name),"url(../../images/default/default-album-icon.png)"!=r.style.backgroundImage&&(r.style.backgroundImage="url(../../images/default/default-album-icon.png)"),"../../images/default/default_background.png"!=i.src&&(i.src="../../images/default/default_background.png"),ID3.read(e[n],{onSuccess:function(e){console.log(e);const a=e.tags.picture.data;const n=e.tags.picture.format;const o=e.tags.title;const l=e.tags.artist;if(0!=a.length&&null!=n){let e="";for(var c=0;c<a.length;c++)e+=String.fromCharCode(a[c]);var d="data:"+n+";base64,"+window.btoa(e);r.style.backgroundImage="url("+d+")",i.src=d}""!=o&&""!=l&&(t.textContent=l+" - "+o)},onError:function(e){console.log(e)}}),replaceurl("player=true&input="+l),a.play(),setTimeout(function(){s=true},100)}}a.src=v,a.load();var y=e[0].name;t.textContent!="Unknown Artist - "+e[0].name&&(t.textContent="Unknown Artist - "+e[0].name),"url(../../images/default/default-album-icon.png)"!=r.style.backgroundImage&&(r.style.backgroundImage="url(../../images/default/default-album-icon.png)"),"../../images/default/default_background.png"!=i.src&&(i.src="../../images/default/default_background.png"),ID3.read(e[0],{onSuccess:function(e){console.log(e);const a=e.tags.picture.data;const n=e.tags.picture.format;const o=e.tags.title;const l=e.tags.artist;if(0!=a.length&&null!=n){let e="";for(var c=0;c<a.length;c++)e+=String.fromCharCode(a[c]);var d="data:"+n+";base64,"+window.btoa(e);r.style.backgroundImage="url("+d+")",i.src=d}""!=o&&""!=l&&(t.textContent=l+" - "+o)},onError:function(e){console.log(e)}}),replaceurl("player=true&input="+y),a.play();var h=new AudioContext;console.log(h);var p=h.createMediaElementSource(a);var b=h.createAnalyser();var w=0;var I=document.getElementById("canvas");window.devicePixelRatio;I.width=window.innerWidth,I.height=window.innerHeight;var M=I.getContext("2d");p.connect(b);var E=h.createGain();b.connect(E),E.connect(h.destination);var P=512;b.fftSize=P,b.maxDecibels=-3,b.minDecibels=-150;var C=b.frequencyBinCount;console.log(C),console.log(b);var k=new Uint8Array(C);var A=new Uint8Array(P);function S(){I.width=window.innerWidth,I.height=window.innerHeight;const e=I.width/2;const t=I.height/2;var n=I.height/3;var r=I.width;var i=I.height;var o=r/C-1;var l;requestAnimationFrame(S),b.getByteFrequencyData(k),b.getByteTimeDomainData(A);var d=m(a.currentTime);var s=m(a.duration);c.innerHTML=d+" / "+s,w=getRMS(k),M.clearRect(0,0,r,i),M.fillStyle="#000000",M.globalAlpha=.3,M.fillRect(0,0,r,i),M.globalAlpha=1;let g=w/255*n;E.gain.setValueAtTime(u.value/100,a.currentTime);for(var v=0;v<C;v++){l=k[v]/255*n,M.save(),M.translate(e,t),M.rotate(90+v*(2*Math.PI/C));var f=l/n*255+25*(v/C);var y=250*(v/C);var h=50;M.fillStyle="rgb("+f+","+y+","+h+")",M.fillRect(0,0+g,o,l),M.fillStyle="rgb(255,255,255)",M.fillRect(0,0+g+l,o,4),M.restore()}M.beginPath(),M.arc(e,t,g,0,2*Math.PI,false),M.fillStyle="rgb("+calcRMSColor(w)+", "+calcRMSColor(w)+",0)",M.fill(),M.closePath()}S(),a.play(),n.addEventListener("change",function(){a.currentTime=n.value}),d.addEventListener("click",function(){true==u.hidden?u.hidden=false:u.hidden=true}),a.addEventListener("timeupdate",function(){n.value=a.currentTime,n.max=a.duration}),l.addEventListener("click",function(){"MediaPlayerIcon icon-pause"==this.className?(this.className="MediaPlayerIcon icon-play",a.pause()):(this.className="MediaPlayerIcon icon-pause",a.play())}),a.addEventListener("ended",function(){l.className="MediaPlayerIcon icon-play",n.value=n.max,g+=1,e.length>1&&f(a,g)}),a.addEventListener("pause",function(){l.className="MediaPlayerIcon icon-play"}),a.addEventListener("play",function(){l.className="MediaPlayerIcon icon-pause"})}});
